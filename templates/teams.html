{% extends "base.html" %}
{% block title %}Teams - Jira{% endblock %}

{% block content %}
<style>
  .teams-container {
    margin-left: 240px;
    padding: 2rem;
    background-color: #f4f6fa;
    min-height: calc(100vh - 60px);
  }

  h2, h3 {
    margin-bottom: 1rem;
  }

  .teams-actions {
    margin-bottom: 1.5rem;
  }

  button {
    margin-right: 1rem;
    padding: 0.5rem 1rem;
    background-color: #0052cc;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover {
    background-color: #003d99;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-bottom: 2rem;
  }

  th, td {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid #e2e8f0;
  }

  th {
    background: #e9eef5;
    font-weight: 600;
  }

  tr:last-child td {
    border-bottom: none;
  }

  .error {
    color: red;
    margin-top: 1rem;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    padding-top: 5%;
  }

  .modal-content {
    background-color: #fff;
    margin: auto;
    padding: 2rem;
    width: 400px;
    border-radius: 8px;
    position: relative;
  }

  .modal-close {
    position: absolute;
    right: 1rem;
    top: 1rem;
    font-size: 1.5rem;
    cursor: pointer;
  }

  label {
    display: block;
    margin-top: 1rem;
  }

  select, input[type="text"] {
    width: 100%;
    padding: 0.4rem;
    margin-top: 0.2rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

</style>

<!-- Sidebar Navigation -->
<div class="dashboard-sidebar">
  <h4>Navigation</h4>
  <a href="/projects">Projects</a>
  <a href="/teams">Teams</a>
  <a href="#tickets">Tickets</a>
  <a href="#sprints">Sprints</a>
  <a href="#notifications">Notifications</a>
  <a href="#" onclick="logout()" style="color:#cc0000; font-weight:600;">Logout</a>
</div>

<!-- Main Teams Section -->
<div class="teams-container">
  <h2>Teams</h2>
  <div class="teams-actions">
    <button onclick="openModal('createTeamModal')">+ Create Team</button>
  </div>
  <div class="error" id="error-msg" style="display:none;"></div>

  <table>
    <thead>
      <tr>
        <th>Team Name</th>
        <th>Members</th>
        <th>Projects</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="teams-tbody">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Create Team Modal -->
<div id="createTeamModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal('createTeamModal')">&times;</span>
    <h3>Create Team</h3>
    <label>Team Name</label>
    <input type="text" id="team-name" />

    <label>Select Members</label>
    <select id="member-select" multiple></select>

    <br/><br/>
    <button onclick="submitTeam()">Create</button>
  </div>
</div>

<!-- Assign Project Modal -->
<div id="assignProjectModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal('assignProjectModal')">&times;</span>
    <h3>Assign Project</h3>
    <label>Select Project</label>
    <select id="project-select"></select>

    <br/><br/>
    <button onclick="submitAssignProject()">Assign</button>
  </div>
</div>

<!-- Add Member Modal -->
<div id="addMembersModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal('addMembersModal')">&times;</span>
    <h3>Add Members</h3>
    <label>Select Members</label>
    <select id="new-member-select" multiple></select>

    <br/><br/>
    <button onclick="submitAddMembers()">Add</button>
  </div>
</div>

<script>
let selectedTeamId = null;

function logout() {
  localStorage.removeItem('access_token');
  localStorage.removeItem('user_info');
  window.location.href = '/login';
}

function requireAuth() {
  const token = localStorage.getItem('access_token');
  if (!token) {
    window.location.href = '/login';
    return null;
  }
  return token;
}

function openModal(id) {
  document.getElementById(id).style.display = 'block';
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

async function loadTeamsAndDropdowns() {
  const token = requireAuth();
  const headers = { 'Authorization': 'Bearer ' + token };

  try {
    const res = await fetch('/teams/all', { headers });
    if (!res.ok) throw new Error("Session expired. Please log in again.");
    const data = await res.json();

    const teams = data.teams || [];
    const users = data.users || [];
    const projects = data.projects || [];

    // Load teams into table
    const tbody = document.getElementById("teams-tbody");
    tbody.innerHTML = "";
    teams.forEach(team => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${team.name}</td>
        <td>${team.members.join(", ") || "—"}</td>
        <td>${team.projects.join(", ") || "—"}</td>
        <td>
          <button onclick="showAssignProject(${team.id})">Assign Project</button>
          <button onclick="showAddMembers(${team.id})">Add Members</button>
          <button onclick="deleteTeam(${team.id})" style="color: red;">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Populate members dropdown
    const memberSelect = document.getElementById("member-select");
    const newMemberSelect = document.getElementById("new-member-select");
    [memberSelect, newMemberSelect].forEach(select => {
      select.innerHTML = '';
      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user.id;
        option.textContent = user.name;
        select.appendChild(option);
      });
    });

    // Populate projects dropdown
    const projectSelect = document.getElementById("project-select");
    projectSelect.innerHTML = '<option value="">Select Project</option>';
    projects.forEach(project => {
      const option = document.createElement("option");
      option.value = project.id;
      option.textContent = project.name;
      projectSelect.appendChild(option);
    });

  } catch (err) {
    document.getElementById("error-msg").textContent = err.message;
    document.getElementById("error-msg").style.display = "block";
  }
}

async function submitTeam() {
  const token = requireAuth();
  const headers = {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  };

  const name = document.getElementById("team-name").value;
  const member_ids = Array.from(document.getElementById("member-select").selectedOptions).map(o => +o.value);

  const res = await fetch('/teams', {
    method: "POST",
    headers,
    body: JSON.stringify({ name, member_ids })
  });

  if (res.ok) {
    closeModal('createTeamModal');
    loadTeamsAndDropdowns();
  } else {
    alert("Error creating team.");
  }
}

function showAssignProject(teamId) {
  selectedTeamId = teamId;
  openModal('assignProjectModal');
}

async function submitAssignProject() {
  const token = requireAuth();
  const headers = {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  };
  const project_id = +document.getElementById("project-select").value;

  const res = await fetch(`/teams/${selectedTeamId}/assign_project`, {
    method: "POST",
    headers,
    body: JSON.stringify({ project_id })
  });

  if (res.ok) {
    closeModal('assignProjectModal');
    loadTeamsAndDropdowns();
  } else {
    alert("Error assigning project.");
  }
}

function showAddMembers(teamId) {
  selectedTeamId = teamId;
  openModal('addMembersModal');
}
async function deleteTeam(teamId) {
  if (!confirm("Are you sure you want to delete this team? This action cannot be undone.")) return;

  const token = requireAuth();
  const headers = {
    'Authorization': 'Bearer ' + token
  };

  try {
    const res = await fetch(`/teams/${teamId}`, {
      method: "DELETE",
      headers
    });

    if (res.ok) {
      alert("Team deleted successfully.");
      loadTeams(); // refresh the team table
    } else {
      const data = await res.json();
      alert("Error: " + (data.message || "Failed to delete team."));
    }
  } catch (err) {
    console.error("Delete Error:", err);
    alert("An error occurred while deleting the team.");
  }
}


async function submitAddMembers() {
  const token = requireAuth();
  const headers = {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  };
  const member_ids = Array.from(document.getElementById("new-member-select").selectedOptions).map(o => +o.value);

  const res = await fetch(`/teams/${selectedTeamId}/members`, {
    method: "PUT",
    headers,
    body: JSON.stringify({ member_ids })
  });

  if (res.ok) {
    closeModal('addMembersModal');
    loadTeamsAndDropdowns();
  } else {
    alert("Error adding members.");
  }
}

window.onload = loadTeamsAndDropdowns;
</script>


{% endblock %}
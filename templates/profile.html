{% extends "base.html" %}
{% block title %}Profile - Jira{% endblock %}

{% block content %}
<style>
  .profile-container {
    max-width: 700px;
    margin: 2rem auto;
    padding: 2.5rem;
    background: #ffffff;
    border: 1px solid #e0e6ed;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    animation: fadeIn 0.5s ease;
  }

  .profile-container h2 {
    text-align: center;
    margin-bottom: 2rem;
    color: #0052cc;
    font-size: 1.8rem;
  }

  .profile-item {
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    animation: slideIn 0.4s ease;
  }

  .profile-item label {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .profile-item span,
  .profile-item input,
  .profile-item select {
    font-size: 1rem;
    padding: 0.75rem;
    border-radius: 6px;
    border: 1px solid #d0d7e2;
    background-color: #f9f9f9;
    transition: box-shadow 0.3s ease;
  }

  .profile-item input:focus,
  .profile-item select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.2);
  }

  .profile-item span {
    background-color: #f1f4f8;
  }

  .btn-row {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .edit-btn,
  .save-btn,
  .cancel-btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }

  .edit-btn {
    background-color: #0052cc;
    color: white;
  }

  .edit-btn:hover {
    background-color: #0041a8;
    transform: translateY(-1px);
  }

  .save-btn {
    background-color: #28a745;
    color: white;
  }

  .save-btn:hover {
    background-color: #218838;
    transform: translateY(-1px);
  }

  .cancel-btn {
    background-color: #6c757d;
    color: white;
  }

  .cancel-btn:hover {
    background-color: #5a6268;
    transform: translateY(-1px);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
</style>

<div class="profile-container" id="profileContent">
  <h2>User Profile</h2>

  <div class="profile-item">
    <label>Name:</label>
    <span id="profile-name-view"></span>
    <input type="text" id="profile-name-edit" style="display: none;">
  </div>

  <div class="profile-item">
    <label>Email:</label>
    <span id="profile-email-view"></span>
    <input type="email" id="profile-email-edit" disabled style="display: none;">
  </div>

  <div class="profile-item">
    <label>Phone:</label>
    <span id="profile-phone-view"></span>
    <input type="text" id="profile-phone-edit" style="display: none;">
  </div>

  <div class="profile-item">
    <label>Availability:</label>
    <span id="profile-availability-view"></span>
    <select id="profile-availability-edit" style="display: none;">
      <option value="">Select</option>
      <option value="Available">Available</option>
      <option value="Busy">Busy</option>
      <option value="Unavailable">Unavailable</option>
    </select>
  </div>

  <div class="profile-item">
    <label>Roles:</label>
    <span id="profile-roles-view"></span>
  </div>

  <div class="btn-row">
    <button class="edit-btn" id="editProfileBtn">Edit Profile</button>
    <button class="save-btn" id="saveProfileBtn" style="display: none;">Save</button>
    <button class="cancel-btn" id="cancelEditBtn" style="display: none;">Cancel</button>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");

    if (!token) {
      alert("You are not logged in.");
      window.location.href = "/login";
      return;
    }

    async function loadProfile() {
      try {
        const res = await fetch("/profile_page", {
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!res.ok) throw new Error("Unauthorized");

        const data = await res.json();

        // View values
        document.getElementById("profile-name-view").textContent = data.name || "-";
        document.getElementById("profile-email-view").textContent = data.email || "-";
        document.getElementById("profile-phone-view").textContent = data.phone || "-";
        document.getElementById("profile-availability-view").textContent = data.availability || "-";
        document.getElementById("profile-roles-view").textContent = (data.roles || []).join(", ");

        // Edit values
        document.getElementById("profile-name-edit").value = data.name || "";
        document.getElementById("profile-email-edit").value = data.email || "";
        document.getElementById("profile-phone-edit").value = data.phone || "";
        document.getElementById("profile-availability-edit").value = data.availability || "";
      } catch (err) {
        alert("Session expired. Please log in again.");
        window.location.href = "/login";
      }
    }

    function toggleEditMode(editing = true) {
      const viewElems = document.querySelectorAll("[id$='-view']");
      const editElems = document.querySelectorAll("[id$='-edit']");

      viewElems.forEach(el => el.style.display = editing ? "none" : "block");
      editElems.forEach(el => el.style.display = editing ? "block" : "none");

      document.getElementById("editProfileBtn").style.display = editing ? "none" : "inline-block";
      document.getElementById("saveProfileBtn").style.display = editing ? "inline-block" : "none";
      document.getElementById("cancelEditBtn").style.display = editing ? "inline-block" : "none";
    }

    document.getElementById("editProfileBtn").addEventListener("click", () => toggleEditMode(true));
    document.getElementById("cancelEditBtn").addEventListener("click", () => toggleEditMode(false));

    document.getElementById("saveProfileBtn").addEventListener("click", async () => {
      const name = document.getElementById("profile-name-edit").value.trim();
      const phone = document.getElementById("profile-phone-edit").value.trim();
      const availability = document.getElementById("profile-availability-edit").value;

      const res = await fetch("/profile_page", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ name, phone, availability })
      });

      if (res.ok) {
        alert("Profile updated successfully.");
        toggleEditMode(false);
        loadProfile();
      } else {
        const err = await res.json();
        alert(err.message || "Failed to update profile.");
      }
    });

    loadProfile();
  });
</script>


{% endblock %}

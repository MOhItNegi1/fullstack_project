{% extends "base.html" %}

{% block title %}Sign Up - Jira{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; justify-content: center; height: calc(100vh - 60px); background: linear-gradient(135deg, #e3ecff, #f4f5f7);">
  <div style="background: #fff; padding: 2.8rem 2.2rem; border-radius: 10px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); max-width: 420px; width: 100%;">
    <h2 style="text-align:center; color:#172B4D;">Create your Jira Account</h2>

    <form id="signupForm">
      <label>Full Name</label>
      <input type="text" id="name" placeholder="Enter full name" required style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">

      <label>Email</label>
      <input type="email" id="email" placeholder="Enter email" required style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">

      <label>Password</label>
      <input type="password" id="password" placeholder="Create password" required style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">

      <label>Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Re-enter password" required style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">

      <label>Select Team</label>
      <select id="team-select" required style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:4px;">
        <option value="">-- Select a Team --</option>
        <!-- Teams will be loaded via JS -->
      </select>

      <button type="submit" style="width:100%; padding:12px; background:#0052cc; color:#fff; border:none; border-radius:6px;">Sign Up</button>
    </form>

    <p id="signupMessage" style="text-align:center; margin-top:15px;"></p>

    <p style="text-align:center; margin-top:15px;">
      Already have an account? <a href="{{ url_for('login_page') }}" style="color:#0052cc;">Log in</a>
    </p>
  </div>
</div>

<script>
  // Populate teams in dropdown
  async function loadTeams() {
    try {
      const response = await fetch("/api/public/teams");
      const teams = await response.json();
      const teamSelect = document.getElementById("team-select");
      teams.forEach(team => {
        const option = document.createElement("option");
        option.value = team.id;
        option.textContent = team.name;
        teamSelect.appendChild(option);
      });
    } catch (err) {
      console.error("Failed to load teams", err);
    }
  }

  document.addEventListener("DOMContentLoaded", loadTeams);

  document.getElementById("signupForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const teamId = document.getElementById("team-select").value;
    const message = document.getElementById("signupMessage");

    if (password !== confirmPassword) {
      message.style.color = "red";
      message.textContent = "❌ Passwords do not match.";
      return;
    }

    if (!teamId) {
      message.style.color = "red";
      message.textContent = "❌ Please select a team.";
      return;
    }

    const response = await fetch("/api/auth/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password, name, team_id: parseInt(teamId) })
    });

    const result = await response.json();

    if (response.ok) {
      message.style.color = "green";
      message.textContent = "✅ " + result.message;
      setTimeout(() => window.location.href = "{{ url_for('login_page') }}", 1500);
    } else {
      message.style.color = "red";
      message.textContent = "❌ " + result.message;
    }
  });
</script>
{% endblock %}
